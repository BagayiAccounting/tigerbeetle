<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TigerBeetle WASM Client Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .result {
            background-color: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        textarea {
            height: 100px;
        }
    </style>
</head>
<body>
    <h1>TigerBeetle WASM Client Example</h1>
    
    <div class="container">
        <h2>Client Configuration</h2>
        <label>Cluster ID:</label>
        <input type="text" id="clusterId" value="0" />
        
        <label>Base URL (TigerBeetle Proxy Server):</label>
        <input type="text" id="baseUrl" value="http://localhost:8080" />
        
        <button onclick="createClient()">Create Client</button>
        <div id="clientResult" class="result"></div>
    </div>

    <div class="container">
        <h2>Create Account</h2>
        <label>Account ID:</label>
        <input type="text" id="accountId" />
        <button onclick="generateAccountId()">Generate ID</button>
        
        <label>Ledger:</label>
        <input type="number" id="ledger" value="1" />
        
        <label>Code:</label>
        <input type="number" id="code" value="1" />
        
        <button onclick="createAccount()">Create Account</button>
        <div id="accountResult" class="result"></div>
    </div>

    <div class="container">
        <h2>Create Transfer</h2>
        <label>Transfer ID:</label>
        <input type="text" id="transferId" />
        <button onclick="generateTransferId()">Generate ID</button>
        
        <label>Debit Account ID:</label>
        <input type="text" id="debitAccountId" />
        
        <label>Credit Account ID:</label>
        <input type="text" id="creditAccountId" />
        
        <label>Amount:</label>
        <input type="text" id="amount" value="100" />
        
        <label>Ledger:</label>
        <input type="number" id="transferLedger" value="1" />
        
        <label>Code:</label>
        <input type="number" id="transferCode" value="1" />
        
        <button onclick="createTransfer()">Create Transfer</button>
        <div id="transferResult" class="result"></div>
    </div>

    <div class="container">
        <h2>Lookup Accounts</h2>
        <label>Account IDs (JSON array):</label>
        <textarea id="lookupAccountIds" placeholder='["account_id_1", "account_id_2"]'></textarea>
        
        <button onclick="lookupAccounts()">Lookup Accounts</button>
        <div id="lookupResult" class="result"></div>
    </div>

    <script type="module">
        import init, { WasmClient, wasm_generate_id } from '/pkg/tigerbeetle.js';

        let client = null;

        // Initialize WASM module
        async function initWasm() {
            await init();
            console.log('TigerBeetle WASM module initialized');
            
            // Generate initial IDs
            document.getElementById('accountId').value = wasm_generate_id();
            document.getElementById('transferId').value = wasm_generate_id();
        }

        // Create client
        window.createClient = async function() {
            try {
                const clusterId = document.getElementById('clusterId').value;
                const addresses = document.getElementById('baseUrl').value;
                
                client = new WasmClient(clusterId, addresses);
                
                document.getElementById('clientResult').textContent = 
                    `Client created successfully!\nCluster ID: ${client.get_cluster_id()}\nAddresses: ${client.get_addresses()}\n\nConnecting...`;
                
                // Automatically connect after creating client
                await client.connect();
                
                document.getElementById('clientResult').textContent += '\nConnection completed! Ready for operations.';
                
            } catch (error) {
                document.getElementById('clientResult').textContent = `Error: ${error}`;
            }
        };

        // Generate account ID
        window.generateAccountId = function() {
            document.getElementById('accountId').value = wasm_generate_id();
        };

        // Generate transfer ID
        window.generateTransferId = function() {
            document.getElementById('transferId').value = wasm_generate_id();
        };

        // Create account
        window.createAccount = async function() {
            if (!client) {
                document.getElementById('accountResult').textContent = 'Please create a client first';
                return;
            }

            try {
                // Create account object directly as JavaScript object
                const account = {
                    id: document.getElementById('accountId').value,
                    ledger: parseInt(document.getElementById('ledger').value),
                    code: parseInt(document.getElementById('code').value)
                };
                
                const result = await client.create_accounts([account]);
                document.getElementById('accountResult').textContent = 
                    `Request sent!\nAccount: ${JSON.stringify(account, null, 2)}\nServer Response: ${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                document.getElementById('accountResult').textContent = `Error: ${error}`;
            }
        };

        // Create transfer
        window.createTransfer = async function() {
            if (!client) {
                document.getElementById('transferResult').textContent = 'Please create a client first';
                return;
            }

            try {
                // Create transfer object directly as JavaScript object
                const transfer = {
                    id: document.getElementById('transferId').value,
                    debit_account_id: document.getElementById('debitAccountId').value,
                    credit_account_id: document.getElementById('creditAccountId').value,
                    amount: document.getElementById('amount').value,
                    ledger: parseInt(document.getElementById('transferLedger').value),
                    code: parseInt(document.getElementById('transferCode').value)
                };
                
                const result = await client.create_transfers([transfer]);
                document.getElementById('transferResult').textContent = 
                    `Request sent!\nTransfer: ${JSON.stringify(transfer, null, 2)}\nServer Response: ${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                document.getElementById('transferResult').textContent = `Error: ${error}`;
            }
        };

        // Lookup accounts
        window.lookupAccounts = async function() {
            if (!client) {
                document.getElementById('lookupResult').textContent = 'Please create a client first';
                return;
            }

            try {
                const accountIdsStr = document.getElementById('lookupAccountIds').value;
                const accountIds = JSON.parse(accountIdsStr || '[]');
                
                const result = await client.lookup_accounts(accountIds);
                document.getElementById('lookupResult').textContent = 
                    `Request sent!\nAccount IDs: ${JSON.stringify(accountIds, null, 2)}\nServer Response: ${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                document.getElementById('lookupResult').textContent = `Error: ${error}`;
            }
        };

        // Initialize when page loads
        initWasm();
    </script>

    <div class="container">
        <h2>‚ö†Ô∏è Important: What's Actually Running</h2>
        <div style="background-color: #fff3cd; padding: 15px; border: 1px solid #ffeaa7; border-radius: 5px; margin: 10px 0;">
            <h3>üîç Current Architecture:</h3>
            <ul>
                <li><strong>‚úÖ TigerBeetle WASM Client</strong> - Running in your browser</li>
                <li><strong>‚ùå TigerBeetle Database</strong> - NOT running (would need external server)</li>
            </ul>
            
            <h3>üìã What This Demo Shows:</h3>
            <ul>
                <li>‚úÖ WASM client loads successfully</li>
                <li>‚úÖ JavaScript API bindings work</li>
                <li>‚úÖ ID generation functions</li>
                <li>‚úÖ Type conversions (JS objects ‚Üî TigerBeetle structs)</li>
                <li>‚ö†Ô∏è Network calls simulate success (no real database)</li>
            </ul>
        </div>
        
        <h3>üöÄ To Connect to Real TigerBeetle:</h3>
        <ol>
            <li><strong>Start TigerBeetle server:</strong> <code>tigerbeetle start --addresses=3001 data.db</code></li>
            <li><strong>Update address:</strong> Change "Base URL" to <code>3001</code> (direct TCP)</li>
            <li><strong>Or use HTTP proxy:</strong> Set up proxy at <code>http://localhost:8080</code></li>
        </ol>
        
        <h3>üìù HTTP Proxy Endpoints (if using proxy):</h3>
        <ul>
            <li><code>POST /accounts</code> - Create accounts</li>
            <li><code>POST /transfers</code> - Create transfers</li>
            <li><code>POST /accounts/lookup</code> - Lookup accounts</li>
            <li><code>POST /transfers/lookup</code> - Lookup transfers</li>
        </ul>
        
        <div style="background-color: #e7f3ff; padding: 10px; border-left: 4px solid #2196F3; margin: 10px 0;">
            <strong>üí° Key Point:</strong> The TigerBeetle <em>client</em> runs in WASM for web compatibility, 
            but the TigerBeetle <em>database</em> runs as a native server for performance.
        </div>
    </div>
</body>
</html>
